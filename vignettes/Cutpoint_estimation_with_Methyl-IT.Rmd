---
title: "Optimal cutpoint for the methylation signal"
subtitle: "Detection of the methylation signal with Methyl-IT"
author: |
 | Robersy Sanchez
 | rus547@psu.edu
 | Mackenzie's lab
 
 | Department of Biology and Plant Science. 
 | Pennsylvania State University, University Park, PA 16802
 | Maintainer: Robersy Sanchez
date: "`r format(Sys.time(), '%d %B %Y')`"
fontsize: 11pt
fontfamily: "serif"
bibliography: bibliography.bib
output:
  rmarkdown::html_document: 
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: true
    number_sections: true
    highlight: tango
    theme: united
    geometry: margin=0.8in
    keep_md: yes
  
abstract: |
  The discrimination of the methylation signal from the stochastic methylation
  background resultant from the standard (non-stressful) biological processes is
  a critical step for the genome-wide methylation analysis. Such a
  discrimination requires for the knowledge of the probability distribution of
  the information divergence of methylation levels and a proper evaluation of
  the classification performance of differentially methylated positions (DMPs)
  into two classes: DMPs from control and DMPs from treatment.
  
---

<style type="text/css">

.list-group-item.active, .list-group-item.active:focus, 
.list-group-item.active:hover {
    z-index: 2;
    color: #fff;
    background-color: #337ab7;
    border-color: #337ab7;
}

.tocify-subheader .tocify-item {
  font-size: 0.80em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify-header .tocify-item {
  font-size: 0.85em;
  padding-left: 20px;
  text-indent: 0;
}

body{ /* Normal  */
      font-size: 18px;
      font-family: "Times New Roman", Times, serif;
      text-align: justify
  }
td {  /* Table  */
  font-size: 8px;
}

h1.title {
  font-size: 38px;
  font-family: "Times New Roman", Times, serif;
  color: DarkRed;
  .subTitle {
  font-size: 24px;
  font-family: "Times New Roman", Times, serif;
  color: DarkRed;
  }
}

h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
    color: DarkBlue;
    font-family: "Times New Roman", Times, serif;
}
h3 { /* Header 3 */
   font-size: 18px;
   color: DarkBlue;
   font-family: "Times New Roman", Times, serif;
}
code.r{ /* Code block */
    font-size: 14px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivation
The probability of extreme methylation changes occurring spontaneously in a
control population by the stochastic fluctuations inherent to biochemical
processes and DNA maintenance [@Ngo2016], requires the discrimination of this
background variation from a biological treatment signal. The stochasticity of
the the methylation process derives from the stochasticity inherent to
biochemical processes [@Min2005; @Koslover2012]. There are fundamental physical
reasons to acknowledge that biochemical processes are subject to noise and
fluctuations [@Samoilov2006; @Eldar2010]. So, regardless constant environment,
statistically significant methylation changes can be found in control population
with probability greater than zero and proportional to a Boltzmann factor
[@Sanchez2016].

Natural signals and those generated by human technology are not free of noise
and, as mentioned above, the methylation signal is no exception. Only signal
detection based approaches are designed to filter out the signal from the noise,
in natural and in human generated signals.

The stochasticity of methylation regulatory machinery effects is presumed to
reflect system heterogeneity; cells from the same tissue are not necessarily in
the same state, and therefore, corresponding cytosine sites differ in their
methylation status. Consequently, overall organismal response is conveyed as a
statistical outcome that distinguishes the regulatory methylation signal from
statistical background “noise”. Estimation of optimal cutoff value for the
signal is an additional step to remove any remaining potential methylation
background noise with probability $0 ≤ \alpha ≤ 0.05$. We define as a
methylation signal (DMP) each cytosine site with Hellinger Divergence values
above the cutpoint (shown [@Sanchez2019].

As a result, a differentially methylated position (DMP) as a cytosine position
with high probability to be altered in methylation due to a treatment effect,
distinct from spontaneous variation detected in the control population.

Note: This example was made with the MethylIT version 0.3.2 available at https://github.com/genomaths/MethylIT.  

## Data generation
For the current example on methylation analysis with Methyl-IT we will use
simulated data. Read-count matrices of methylated and unmethylated cytosine are
generated with MethylIT.utils function *simulateCounts*. A standard analysis of this
dataset is given in the web page: [Methylation analysis with Methyl-IT](https://genomaths.github.io/Methylation_analysis_with_Methyl-IT.html)

```{r Exp-methlevel, include = TRUE, message = FALSE}
library(MethylIT)
library(MethylIT.utils)

bmean <- function(alpha, beta) alpha/(alpha + beta)
alpha.ct <- 0.09
alpha.tt <- 0.2

# The number of cytosine sites to generate
sites = 50000 
# Set a seed for pseudo-random number generation
set.seed(124)
control.nam <- c("C1", "C2", "C3")
treatment.nam <- c("T1", "T2", "T3")

# Reference group 
ref0 = simulateCounts(num.samples = 4, sites = sites, alpha = alpha.ct, beta = 0.5,
                      size = 50, theta = 4.5, sample.ids = c("R1", "R2", "R3", "R4"))
# Control group
ctrl = simulateCounts(num.samples = 3, sites = sites, alpha = alpha.ct, beta = 0.5,
                      size = 50, theta = 4.5, sample.ids = control.nam)
# Treatment group
treat = simulateCounts(num.samples = 3, sites = sites, alpha = alpha.tt, beta = 0.5,
                       size = 50, theta = 4.5, sample.ids = treatment.nam)

# Reference sample
ref = poolFromGRlist(ref0, stat = "mean", num.cores = 4L, verbose = FALSE)
```

## Methylation level divergences
Total variation distance and Hellinger divergence are computed with [estimateDivergence](https://genomaths.github.io/methylit/reference/estimateDivergence.html) 
function
```{r divs}
divs <- estimateDivergence(ref = ref, indiv = c(ctrl, treat), Bayesian = TRUE, 
                           num.cores = 6L, percentile = 1, verbose = FALSE)

```

To get some statistical description about the sample is useful. Here, empirical
critical values for the probability distribution of $H$ and $TV$ can is obtained
using *quantile* function from the R package *stats*.
```{r critical.val, include = TRUE}
critical.val <- do.call(rbind, lapply(divs, function(x) {
  x <- x[x$hdiv > 0]
  hd.95 = quantile(x$hdiv, 0.95)
  tv.95 = quantile(abs(x$TV), 0.95)
  return(c(tv = tv.95, hd = hd.95))
}))
critical.val

```
## Estimation of potential DMPs with Methyl-IT
In Methyl-IT, DMP estimation requires for the knowledge of the probability distribution 
of the noise (plus signal), which is used as null hypothesis.

The best fitted distribution model can be estimated with function
[gofReport](https://genomaths.github.io/methylit/reference/gofReport.html).
Here, for illustration purposes, we will use specific estimations based on 2-
and 3-parameter gamma distribution models directly using function [nonlinearFitDist](https://genomaths.github.io/methylit/reference/nonlinearFitDist.html).  

### Potential DMPs estimated with 2-parameter gamma distribution model

```{r g2p}
nlms.g2p <- nonlinearFitDist(divs, column = 9L, verbose = FALSE, num.cores = 6L,
                            dist.name = "Gamma2P")

# Potential DMPs from 'Gamma2P' model
pDMPs.g2p <- getPotentialDIMP(LR = divs, nlms = nlms.g2p,  div.col = 9L, 
                             tv.cut = 0.68, tv.col = 7, alpha = 0.05, 
                             dist.name = "Gamma2P")
```

### Potential DMPs estimated with 3-parameter gamma distribution model

```{r g3p}
nlms.g3p <- nonlinearFitDist(divs, column = 9L, verbose = FALSE, num.cores = 6L,
                            dist.name = "Gamma3P")

# Potential DMPs from 'Gamma2P' model
pDMPs.g3p <- getPotentialDIMP(LR = divs, nlms = nlms.g3p,  div.col = 9L, 
                             tv.cut = 0.68, tv.col = 7, alpha = 0.05, 
                             dist.name = "Gamma3P")
```

## Cutpoint estimation
As a result of the natural spontaneous variation, naturally occurring DMPs can
be identified in samples from the control and treatment populations.
Machine-learning algorithms implemented in Methyl-IT are applied to discriminate
treatment-induced DMPs from those naturally generated.

The simple cutpoint estimation available in Methyl-IT is based on the
application of Youden index [@Youden1950]. Although cutpoints are estimated for
a single variable, the classification performance can be evaluated for several
variables and applying different model classifiers.

In the current example, the column carrying *TV* (*div.col* = 7L) will be used
to estimate the cutpoint. The column values will be expressed in terms of
$TV_d=|p_{tt}-p_{ct}|$. A minimum cutpoint value for *TV* derived from the
minimum 95% quantile (*tv.cut* = 0.92) found in the treatment group will be
applied (see [Methylation analysis with
Methyl-IT](https://genomaths.github.io/Methylation_analysis_with_Methyl-IT.html)).

Next, a logistic model classifier will be fitted with the 60% (*prop* = 0.6)
of the raw data (training set) and then the resting 40% of individual samples
will be used to evaluate the model performance. The predictor variable included
in the model are specified with function parameter *column* (for more detail see [*estimateCutPoint*](https://genomaths.github.io/methylit/reference/estimateCutPoint.html)
or type ?estimateCutPoint in R console).

### Simple cutpoint estimation for Gamma2P model
Here, we use the results of modeling the distribution of the Hellinger
divergence (*HD*) of methylation levels through a 2-parameter gamma probability
distribution model. The critical values for $HD_{\alpha = 0.05}^{CT_{G2P}}$ used
to get potential DMPs were:

```{r}
nams <- names(nlms.g2p)
crit <- unlist(lapply(nlms.g2p, function(x) qgamma(0.95, shape = x$Estimate[1],
                                                   scale = x$Estimate[2])))
names(crit) <- nams
crit

```

As before the cutpoint is estimated based on 'Youden Index' [@Youden1950]. A
PCA+LDA model classifier (*classifier* = "pca.lda") is applied. That is, a
principal component analysis (PCA) is applied on the original raw matrix of data
and the four possible component (*n.pc* = 4) derived from the analysis are used
in a further linear discriminant analysis (LDA). A scaling step is applied to
the raw matrix of data before the application of the mentioned procedure
(*center* = TRUE, *scale* = TRUE). Here, PCA will yield new orthogonal
(non-correlated) variables, the principal components, which prevent any
potential bias effect originated by any correlation or association of the
original variables.

By using function
[estimateCutPoint](https://genomaths.github.io/methylit/reference/estimateCutPoint.html),
we can estimate the cutpoint, based on *HD* (*div.col* = 9L) or on $TV_d$
(*div.col* = 7L):
```{r g2p_cutpoint, include = TRUE}
# Cutpoint estimation for the FT approach using the ECDF critical value
cut.g2p = estimateCutPoint(LR = pDMPs.g2p, simple = TRUE,
                            column = c(hdiv = TRUE, bay.TV = TRUE, 
                                       wprob = TRUE, pos = TRUE),
                            classifier1 = "pca.lda", n.pc = 4, 
                            control.names = control.nam,
                            treatment.names = treatment.nam,
                            center = TRUE, scale = TRUE,
                            clas.perf = TRUE, prop = 0.6,
                           div.col = 9L)
cut.g2p
```

As indicated above, the model classifier performance and its corresponding false
discovery rate can be retrieved as:
```{r g2p_cut, include = TRUE}
cut.g2p$testSetPerformance
cut.g2p$testSetModel.FDR
```

Here, DMP classification is modeled with PCA+QDA classifier (*classifier* =
"pca.lda"). That is, principal component analysis (PCA) is applied on the
original raw matrix of data and the four possible component (*n.pc* = 4) are
used in a further linear discriminant analysis (LDA). A scaling step is applied
to the raw matrix of data before the application of the mentioned procedure
(*center* = TRUE, *scale* = TRUE).
Next, a different model classifier can be applied to model the classification
derived from the previous cutpoint estimation.

### Simple cutpoint estimation for Gamma3P model
The same analyses for the cutpoint estimation can be performed for 3P gamma model

```{r g3p_cutpoint, include = TRUE}
# Cutpoint estimation for the FT approach using the ECDF critical value
cut.g3p = estimateCutPoint(LR = pDMPs.g3p, simple = TRUE,
                            column = c(hdiv = TRUE, bay.TV = TRUE, 
                                       wprob = TRUE, pos = TRUE),
                            classifier1 = "pca.lda", n.pc = 4, 
                            control.names = control.nam,
                            treatment.names = treatment.nam,
                            center = TRUE, scale = TRUE,
                            clas.perf = TRUE, prop = 0.6,
                           div.col = 9L)
cut.g3p
```

As indicated above, the model classifier performance and its corresponding false
discovery rate can be retrieved as:
```{r gp_cut, include = TRUE}
cut.g3p$testSetPerformance
cut.g3p$testSetModel.FDR
```

### DMP prediction based on classification models
The model obtained in the previous step can be used for further prediction with
function
[predict](https://rdrr.io/github/genomaths/MethylIT.utils/man/predict.ProbDistr.html)
from MethylIT.utils package. For example, we would take a random sample and run:
```{r}
set.seed(1)
randsampl <- unlist(pDMPs.g3p)
randsampl <- randsampl[sample.int(length(randsampl), 10)]

pred <- predict(cut.g3p$model, newdata = randsampl)
pred
```

The variable *pred$posterior* provides the posterior classification
probabilities that a DMP could belong to control (*CT*) or to treatment (*TT*)
group. The variable '_x_' provides the cytosine methylation changes in terms of
its values in the linear discriminant function LD1. Notice that, for each row,
the sum of posterior probabilities is equal 1. By default, individuals with *TT*
posterior probabilities greater than 0.5 are predicted to belong to the
treatment class. For example:
```{r pred}
classfiction = rep("CT", 10)
classfiction[pred$posterior[, 2] > 0.5] <- "TT"
classfiction
```

We can be more strict increasing the posterior classification probability cutoff
```{r pred2}
classfiction = rep("CT", 10)
classfiction[pred$posterior[, 2] > 0.7] <- "TT"
classfiction
```

The posterior classification probability cutoff can be controlled with parameter
_post.cut_ from 
[estimateCutPoint](https://genomaths.github.io/methylit/reference/estimateCutPoint.html)
function (default: $post.cut=0.5$).

## Machine-learning (ML) based approach to search for an optimal cutpoint
In the next example the cutpoint estimation for the Hellinger divergence of
methylation levels (*div.col* = 9L) is accomplished. Function *estimateCutPoint*
can be used to search for a cutpoint as well. Two model classifiers can be used.
*classifiers1* will be used to estimate the posterior classification
probabilities of DMP into those from control and those from treatment. These
probabilities are then used to estimate the cutpoint in the range of values
from, say, 0.5 to 0.8. Next, a *classifier2* will be used to evaluate the
classification performance. In this case, the search for an optimal cutpoint is
accomplished maximizing the accuracy (*stat* = 0) of *classifier2*.

### ML cutpoint estimation for potential DMPs based on Gamma2P model 
The ML search for an optimal cutpoint is accomplished in the set of potential
DMPs, which were identified using a Gamma2P probability distribution model as
null hypothesis.

```{r cutpt_search, include = TRUE}
cut.g2p = estimateCutPoint(LR = pDMPs.g2p, simple = FALSE,
                            column = c(hdiv = TRUE, bay.TV = TRUE, 
                                       wprob = TRUE, pos = TRUE),
                            classifier1 = "pca.lda", 
                            classifier2 = "pca.qda", stat = 0,
                            control.names = control.nam, 
                            treatment.names = treatment.nam, 
                            cut.values = seq(45, 114, 1), post.cut = 0.5,
                            clas.perf = TRUE, prop = 0.6,
                            center = TRUE, scale = TRUE,
                            n.pc = 4, div.col = 9L)
cut.g2p
```

Model performance in the test dataset is:
```{r cuts}
cut.g2p$testSetPerformance
```

Model performance in in the whole dataset is:
```{r confm}
cut.g2p$modelConfMatrix
```

The False discovery rate is:
```{r fdr}
cut.g2p$testSetModel.FDR
```

The model classifier *PCA+LDA* has enough discriminatory power to discriminate
control DMP from those induced by the treatment for *HD* values
$112.4247 \le HD$.

The probabilities $P(HD \le 122.43)$ to observe a cytosine site with $HD \le
112.4247$ on each individual is:
```{r}
nams <- names(nlms.g2p)
crit <- unlist(lapply(nlms.g2p, function(x) pgamma(cut.g2p$cutpoint, shape = x$Estimate[1],
                                                   scale = x$Estimate[2])))
names(crit) <- nams
crit
```

In other words, most of the methylation changes are not (and should not be)
considered DMPs. Notice that although the same *HD* value could be found in the
same differentially methylated cytosine site in control and treatment, if the
probabilities distributions of the information divergences (null hypotheses)
from control and treatment are different, then these DMPs can be distinguished.

### ML cutpoint estimation for potential DMPs based on Gamma3P model 
Likewise, for the 3-parameter gamma model we can search for an optimal cutpoint:
```{r cutp_search, include = TRUE}
cut.g3p = estimateCutPoint(LR = pDMPs.g3p, simple = FALSE,
                            column = c(hdiv = TRUE, TV = TRUE, 
                                       wprob = TRUE, pos = TRUE),
                            classifier1 = "pca.lda", 
                            classifier2 = "pca.qda", stat = 0,
                            control.names = control.nam, 
                            treatment.names = treatment.nam, 
                            cut.values = seq(45, 114, 1), post.cut = 0.5,
                            clas.perf = TRUE, prop = 0.6,
                            center = TRUE, scale = TRUE,
                            n.pc = 4, div.col = 9L)
cut.g3p
```

DMPs are identified with function [selectDIMP](https://genomaths.github.io/methylit/reference/selectDIMP.html)

```{r dmps}
g2p.dmps <- selectDIMP(pDMPs.g2p, div.col = 9L, cutpoint = cut.g2p$cutpoint)
g3p.dmps <- selectDIMP(pDMPs.g3p, div.col = 9L, cutpoint = cut.g3p$cutpoint)
```

## DMPs estimated with Fisher's exact Test (FT)

For comparison purposes DMPs are estimated with Fisher's exact test as well.
```{r ft, results='hide', fig.keep='all', message = FALSE}
ft. = FisherTest(LR = divs, tv.cut = 0.68, pAdjustMethod = "BH",
                     pvalCutOff = 0.05, num.cores = 4L,
                     verbose = FALSE, saveAll = FALSE) 

ft.dmps <- getPotentialDIMP(LR = ft., div.col = 9L, dist.name = "None",
                            tv.cut = 0.68, tv.col = 7, alpha = 0.05)
```

## Classification performance of DMP classification

After the cutpoint application to select DMPs, a Monte Carlo (bootstrap) analysis
reporting several classifier performance indicators can be accomplished by
using function
[*evaluateDIMPclass*](https://genomaths.github.io/MethylIT_HTML_Manual/evaluateDIMPclass.html)
and its settings *output = "mc.val"* and *num.boot*.

### Classification performance for DMPs based on Gamma2P model
```{r g2p_class, include = TRUE}
g2p.class = evaluateDIMPclass(LR = g2p.dmps, control.names = control.nam,
                           treatment.names = treatment.nam,
                           column = c(hdiv = TRUE, TV = TRUE, 
                                      wprob = TRUE, pos = TRUE),
                           classifier = "pca.qda", n.pc = 4, 
                           center = TRUE, scale = TRUE, num.boot = 300,
                           output = "all", prop = 0.6
)
g2p.class$mc.val
```

### Classification performance for DMPs based on Gamma3P model
Likewise the evaluation of the DMP classification performance can be accomplished 
for DMPs estimated based on the $'Gamma3P'$ model:
```{r g3p_class, include = TRUE}
g3p.class = evaluateDIMPclass(LR = g3p.dmps, control.names = control.nam,
                           treatment.names = treatment.nam,
                           column = c(hdiv = TRUE, TV = TRUE, 
                                      wprob = TRUE, pos = TRUE),
                           classifier = "pca.qda", n.pc = 4, 
                           center = TRUE, scale = TRUE, num.boot = 300,
                           output = "all", prop = 0.6
)
g3p.class$mc.val
```
We do not have evidence to support statistical differences between the
classification performances estimated for _'Gamma2P'_ and _'Gamma3P'_ probability
distribution models. Hence, in this case we select the model that yield the
lowest cutpoint

### Classification performance for DMPs based on Fisher's exact test

Classification performance results obtained with Monte Carlos sampling for the 
$Gamma2P$ and $Gamma3P$ models are quite different from those obtained with FT: 
```{r ft_cutpoint5, include = TRUE}
ft.class = evaluateDIMPclass(LR = ft.dmps, control.names = control.nam,
                           treatment.names = treatment.nam, 
                           column = c(hdiv = TRUE, TV = TRUE, 
                                      wprob = TRUE, pos = TRUE),
                           classifier = "pca.lda", n.pc = 4, 
                           center = TRUE, scale = TRUE, num.boot = 300,
                           output = "all", prop = 0.6
)
ft.class$mc.val
```

A quite different story is found when information on the probability
distribution of noise (null hypothesis) is added to the classifier:
```{r ft_cutpoints, include = TRUE}
ft.g2p.dmps <- getPotentialDIMP(LR = ft., nlms = nlms.g2p,  div.col = 9L, 
                                tv.cut = 0.68, tv.col = 7, alpha = 0.05, 
                                dist.name = "Gamma2P")

ft.g2p.class = evaluateDIMPclass(LR = ft.g2p.dmps, control.names = control.nam,
                                 treatment.names = treatment.nam,
                                 column = c(hdiv = TRUE, TV = TRUE, 
                                            wprob = TRUE, pos = TRUE),
                                 classifier = "pca.lda", n.pc = 4, 
                                 center = TRUE, scale = TRUE, num.boot = 300,
                                 output = "all", prop = 0.6
)
ft.g2p.class$mc.val
```

Now, we add additional information about the optimal cutpoint 
```{r ft_cutpoint}
ft.g2p_cutp.dmps <- selectDIMP(ft.g2p.dmps, div.col = 9L, cutpoint = cut.g2p$cutpoint)

ft.g2p_cut.class = evaluateDIMPclass(LR = ft.g2p_cutp.dmps, control.names = control.nam,
                                 treatment.names = treatment.nam,
                                 column = c(hdiv = TRUE, TV = TRUE, 
                                            wprob = TRUE, pos = TRUE),
                                 classifier = "pca.lda", n.pc = 4, 
                                 center = TRUE, scale = TRUE, num.boot = 300,
                                 output = "all", prop = 0.6
)
ft.g2p_cut.class$mc.val

```

In other words, information on the probability distributions of the natural
spontaneous methylation variation in the control and treatment population are
essential to discriminate the background noise from the treatment induced
signal.

## Graphics of DMP classification performance

DMP count data:
```{r dmps_data}
dt <- t(rbind(G2P = sapply(g2p.dmps, length),
              G3P = sapply(g3p.dmps, length),
              FT = sapply(ft.dmps, length),
              FT.G2P = sapply(ft.g2p.dmps, length),
              FT.SD = sapply(ft.g2p_cutp.dmps, length)
    ))
dt
```

The comparison between the approaches FT.G2P and FT.SD (full signal detection on
FT output) tells us that only 255, 306, and 281 cytosine sites detected with FT
in the control samples C1, C2, and C3, respectively, carry methylation signals
comparable (in magnitude) to those signals induced by the treatment.




Classification performance data:
```{r class_perf_data}
df <- data.frame(method = c("FT", "FT.G2P", "FT.SD", "G2P", "G3P"), 
                 rbind(
                       c(colMeans(ft.class$boots)[c(1, 8:11, 18)], FDR = ft.class$con.mat$FDR),
                       c(colMeans(ft.g2p.class$boots)[c(1, 8:11, 18)], FDR = ft.g2p.class$con.mat$FDR),
                       c(colMeans(ft.g2p_cut.class$boots)[c(1, 8:11, 18)], FDR = ft.g2p_cut.class$con.mat$FDR),
                       c(colMeans(g2p.class$boots)[c(1, 8:11, 18)], FDR = g2p.class$con.mat$FDR),
                       c(colMeans(g3p.class$boots)[c(1, 8:11, 18)], FDR = g3p.class$con.mat$FDR)
                 ))
```


Graphics:
```{r dmp_graph, fig.height = 5, fig.width= 14}
color <- c("darkgreen", "#147714FF", "#3D9F3DFF", "#66C666FF",  "#90EE90FF")
dt <- data.frame(dt, sample = names(g2p.dmps))

## ------------------------- DMP count graphic ---------------------------------
par(family = "serif", lwd = 0.1, cex = 1, mar = c(2,5,2,2), mfcol = c(1, 2))
barplot(cbind(FT, FT.G2P, FT.SD, G2P, G3P) ~ sample, 
        panel.first={points(0, 0, pch=16, cex=1e6, col="grey95")
          grid(col="white", lty = 1, lwd = 1)},
        data = dt, beside = TRUE,  legend.text = TRUE, las = 1, lwd = 0.05, yaxt = "n",
        cex.names = 1.4, font = 3, xlab = "", col = color,
        args.legend = list(x=10, y=6000, text.font = 2, box.lwd = 0, horiz = FALSE,
                           adj = 0, xjust = 0.65, yjust = 0.8, bty = "n", cex = 1.2,
                           x.intersp = 0.2, inset = -1, ncol = 1, fill = color))
axis(2, hadj = 0.9, las = 2, lwd = 0.4, tck = -0.02, cex.axis = 1.2, font = 2, line = -0.2)
mtext(side = 2, text = "DMP count", line = 3, cex = 1.4, font = 3)

## ------------------ DMP classifiction performance graphic -------------------
color <- c("mediumblue", "#0000FFFF", "#3949F6FF", "#566CF2FF", "#7390EEFF", "#90B3EAFF", "#ADD8E6FF")
labs <- df$method
  
par(family = "serif", lwd = 0.1, cex = 1, mar = c(4,2,2,10))
x <- barplot(cbind(Accuracy, Sensitivity, Specificity, Pos.Pred.Value, Neg.Pred.Value, 
              Balanced.Accuracy, FDR) ~ method, 
        panel.first={points(0, 0, pch=16, cex=1e6, col="grey95")
          grid(col="white", lty = 1, lwd = 1)}, 
        data = df, beside = TRUE,  legend.text = TRUE, las = 1, lwd = 0.1, yaxt = "n",
        cex.names = 1.4, font = 3, xlab = "", col = color, ylim = c(0,1), 
        args.legend = list(x = 52, y = 1., text.font = 2, box.lwd = 0, horiz = FALSE,
                           adj = 0, xjust = 0.65, yjust = 0.8, bty = "n", cex = 1.2,
                           x.intersp = 0.2, inset = -1, ncol = 1, fill = color))
axis(2, hadj = 0.8, las = 2, lwd = 0.4, tck = -0.02, cex.axis = 1.2, font = 2,
     line = -0.4)
mtext(side = 2, text = "Performance value", line = 2, cex = 1.4, font = 3)

```

FT.G2P and FT.SD approaches lead to excellent classification performances on this
data set. At this point, we can appeal the parsimony principle, follows from
[Occam’s razor](https://www.britannica.com/topic/Occams-razor) that states
“among competing hypotheses, the hypothesis with the fewest assumptions should
be selected. In other words, results indicates that the signal-detection and
machine-learning approach is sufficient [@ElNaqa2018; @Sanchez2019].

# Conclusions 

1. A proper discrimination of the methylation signal from the stochastic
methylation background requires for the knowledge of probability distributions
of the methylation signal from control and treatment population. Such a
knowledge permits a suitable estimation of the cutoff value to discriminate the
methylation signal induced by the treatment from the stochastic methylation
background detected in the control group.   

2. It does not matter how significant a differentially methylation event for a
given cytosine position would be (after the application of some statistical
test), but on how big the probability to be observed in the control group is. In
simple words, if for a given DMP the probability of to be observed in the control
is *big enough*, then such a DMP did not result from a treatment effect.   

3. A suitable evaluation on how much the mentioned probability can be *big
enough* derives by estimating an optimal cutpoint. But a classification into two
groups results from the cutpoint estimation and the problem on the estimation of
such a cutpoint is equivalent to find a discriminatory function (as set by
Fisher, [@Fisher1938; @Green1979]). Cases with function values below some cutoff
are classified in one group, while values above the cutoff are put in the other
group.   

4. MethylIT function
[estimateCutPoint](https://genomaths.github.io/MethylIT_HTML_Manual/estimateCutPoint.html)
permits the estimation and search for an optimal cutpoint by confronting the
problem as in the spirit of the classical signal detection and as a
classification problem. The best model classifier will depend on the dataset
under study.So, uses must check for which is the model classifier with the best
classification performance for his/her dataset.

# References 













